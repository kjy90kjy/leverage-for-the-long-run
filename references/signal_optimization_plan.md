# 비대칭 매수/매도 시그널 최적화 로드맵

## 현재 시스템 한계

현재 레버리지 로테이션 전략(LRS)은 **대칭 시그널**을 사용한다:
- 하나의 dual MA 크로스오버 `(fast, slow)`가 매수와 매도를 동시에 결정
- fast MA > slow MA → 매수 (레버리지), fast MA < slow MA → 매도 (T-Bill)
- 파라미터 공간: 2차원 `(fast, slow)`

**문제점:**
- 최적의 진입 타이밍 ≠ 최적의 탈출 타이밍
- 실전에서는 "느린 진입(whipsaw 회피) + 빠른 탈출(손실 제한)" 같은 비대칭 전략이 유효할 수 있음
- 대칭 그리드 서치에서 나온 최적 파라미터가 진입/탈출 중 어느 쪽에 편향되었는지 알 수 없음

---

## Phase 1: 비대칭 매수/매도 시그널 (4 파라미터)

### 개념

매수와 매도에 각각 다른 dual MA 조건을 사용:
- **매수 조건**: `fast_buy` MA > `slow_buy` MA
- **매도 조건**: `fast_sell` MA < `slow_sell` MA

State machine 방식으로 동작:
- 현재 cash(0) → 매수 조건만 체크
- 현재 invested(1) → 매도 조건만 체크
- **Hysteresis**: 매수/매도 조건이 동시에 성립해도 현재 상태의 반대 조건만 반응

### 파라미터 공간

| 파라미터 | 범위 | 설명 |
|----------|------|------|
| `fast_buy` | 2~50 | 매수용 단기 MA |
| `slow_buy` | 50~350 | 매수용 장기 MA |
| `fast_sell` | 2~50 | 매도용 단기 MA |
| `slow_sell` | 50~350 | 매도용 장기 MA |

총 탐색 공간: ~49 × 301 × 49 × 301 ≈ 2.18억 조합 → 전수 조사 불가능

### 최적화 방법

**Optuna (TPE sampler)** 사용:
- Bayesian optimization으로 유망한 영역을 집중 탐색
- 2,000 trials로 충분한 커버리지 확보 (경험적으로 TPE는 1000~2000에서 수렴)
- 최적화 대상: Sortino ratio (하방 위험 대비 초과수익)

### 오버피팅 방어

- **Walk-forward**: 1985-2014 (train) / 2015-2025 (test) 분할
- **파라미터 안정성**: top-20 trials의 파라미터 분포 분석 — 좁으면 robust, 넓으면 과적합 의심
- **대칭 baseline 비교**: 기존 대칭 그리드 최적값 대비 유의미한 개선 여부 확인

---

## Phase 2: 금리 레짐 추가 (향후)

### 개념

미국 10년물 국채 금리(^TNX)의 추세에 따라 시장 레짐을 분류하고,
레짐별로 다른 MA 파라미터를 적용.

### 레짐 분류 방법

- **금리 상승기**: TNX의 N-day MA 상승 → 레버리지에 불리 (financing cost 증가)
- **금리 하락/안정기**: TNX의 N-day MA 하락 → 레버리지에 유리

### 파라미터 확장

| 레짐 | 파라미터 |
|------|----------|
| 금리 상승 | `(fast_buy_up, slow_buy_up, fast_sell_up, slow_sell_up)` |
| 금리 하락 | `(fast_buy_dn, slow_buy_dn, fast_sell_dn, slow_sell_dn)` |

총 8개 + 레짐 분류용 파라미터 (TNX MA period) → ~9차원

### 경제적 근거

- TQQQ 등 레버리지 ETF의 financing cost는 금리에 직결
- 2022년 같은 급격한 금리 인상기에는 보수적 진입/빠른 탈출이 유리
- ZIRP 기간(2009-2021)에는 공격적 진입이 더 효과적이었을 수 있음

### 주의사항

- ^TNX 데이터는 1962년부터 사용 가능 → 데이터 기간 제한
- 금리 레짐 전환 시점은 사후적으로만 명확 → 실시간 판단 어려움
- 파라미터 9개는 오버피팅 위험 상당 → 강력한 검증 필요

---

## Phase 3: 다중 레짐 (향후 — 권장하지 않음)

### 개념

주식 시장 추세(S&P 200MA) + 금리 추세를 조합하여 4개 레짐:

| S&P 추세 | 금리 추세 | 레짐 | 예상 성격 |
|-----------|-----------|------|-----------|
| 상승 | 하락 | Goldilocks | 공격적 진입 |
| 상승 | 상승 | Overheat | 보수적 진입 |
| 하락 | 하락 | Recession | 빠른 탈출 |
| 하락 | 상승 | Stagflation | 가장 보수적 |

### 위험성

- **파라미터 폭발**: 4 레짐 × 4 파라미터 = 16개 + 레짐 분류용 → 17+차원
- **데이터 부족**: 각 레짐의 데이터 충분성이 검증되지 않음
  - Stagflation 레짐은 역사적으로 매우 드묾 (1970s, 2022 일부)
  - 소수 레짐에서의 최적화는 거의 확실하게 과적합
- **복잡성 대비 효과 의문**: 경험적으로 단순한 전략이 out-of-sample에서 더 robust
- **권장하지 않는 이유**: Phase 2까지의 결과가 충분히 유의미하지 않다면,
  Phase 3는 noise fitting에 불과할 가능성이 높음

---

## 오버피팅 방어 전략 (공통)

### 1. Walk-Forward Optimization
- Train/Test 분할은 최소 7:3 비율
- Test 기간은 최소 하나의 완전한 시장 사이클 포함 필요 (2015-2025: 상승+하락 포함)
- 이상적으로는 rolling walk-forward (5년 train → 2년 test → roll)

### 2. Out-of-Sample 검증
- In-sample 최적값을 out-of-sample에 적용했을 때:
  - Sortino 하락률 < 30% → 합리적
  - Sortino 하락률 > 50% → 과적합 의심
  - Out-of-sample에서 B&H보다 못함 → 확실한 과적합

### 3. 파라미터 안정성 (Robustness)
- Top-N trials의 파라미터 분포:
  - IQR이 전체 범위의 20% 이하 → robust (파라미터 고원 존재)
  - IQR이 전체 범위의 50% 이상 → flat landscape → 의미 있는 최적점 없음
- 최적 파라미터 주변 ±10% 변동 시 성능 변화가 작아야 함

### 4. 경제적 합리성
- 최적 파라미터가 직관적으로 설명 가능해야 함
- 예: "매수는 느린 크로스오버 (whipsaw 방지), 매도는 빠른 크로스오버 (손실 제한)"
- 설명 불가능한 파라미터 조합은 noise fitting일 가능성 높음

---

## 구현 순서

1. **Phase 1 구현** (`optimize_asymmetric.py`)
   - `signal_asymmetric_dual_ma()` 함수 → `leverage_rotation.py`에 추가
   - Optuna 기반 최적화 + walk-forward 검증
   - 결과에 따라 Phase 2 진행 여부 결정

2. **Phase 2** (Phase 1 결과가 유의미한 경우에만)
   - ^TNX 데이터 통합
   - 레짐 분류 로직
   - 확장된 파라미터 공간 최적화

3. **Phase 3** (권장하지 않음 — Phase 2가 극적 개선을 보인 경우에만 검토)
