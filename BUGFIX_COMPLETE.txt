â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            EXPANDING PERCENTILE BUG FIX â€” COMPLETE & VERIFIED             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## CHANGES MADE

âœ… leverage_rotation.py (4 locations)
   â”œâ”€ L303: signal_regime_switching_dual_ma()
   â”œâ”€ L352: signal_vol_regime_adaptive_ma() [ref_vol]
   â”œâ”€ L354: signal_vol_regime_adaptive_ma() [vol_pct]
   â””â”€ L418: signal_macro_regime_dual_ma() [vol_pct]
   â””â”€ L444: signal_macro_regime_dual_ma() [credit spread]

âœ… optimize_regime_grid_v2.py (1 location)
   â””â”€ L85: precompute_vol_regimes()

## WHAT WAS WRONG

Before: vol_pct = rolling_vol.expanding().rank(pct=True) * 100
â”œâ”€ Expanding percentile uses ALL data from 1987-2025
â”œâ”€ 2008 Lehman's 80% vol = 100th percentile (all-time extreme)
â”œâ”€ This warps ALL future signals permanently
â””â”€ Result: 2020 COVID (50% vol) = 95% percentile
           (appears LESS extreme than 2008's lingering shadow)

After: vol_pct = rolling_vol.rolling(252, min_periods=1).rank(pct=True) * 100
â”œâ”€ Rolling 252-day window = 1 year of data only
â”œâ”€ 2008 Lehman's 80% = 100% percentile within 2008 ONLY
â”œâ”€ Does NOT warp future signals
â””â”€ Result: 2020 COVID (50% vol) = 100% percentile
           (properly recognized as 2020's extreme)

## VERIFICATION

Test script: test_vol_percentile_fix.py
Result: âœ… PASSED

Key metrics:
â”œâ”€ 2008-09-15: 25.9% vol â†’ Old: 70.1%, New: 67.1% (fixed âœ“)
â”œâ”€ 2020-03-16: 49.5% vol â†’ Old: 94.7%, New: 100.0% (fixed âœ“)
â””â”€ High-vol days: Old: 5,385/10,141 (53.1%), New: 4,679/10,141 (46.1%)

Chart generated: output/vol_percentile_fix_comparison.png

## IMPACT

ğŸ”´ MUST RE-RUN:
   â”œâ”€ Part 12 (TQQQ-calibrated NDX grid)
   â”‚  â””â”€ optimize_regime_grid_v2.py uses fixed signal
   â”œâ”€ test_macro_regime.py
   â””â”€ analyze_crises.py

âœ… NOT AFFECTED:
   â”œâ”€ Part 1-11 (use dual_ma, not regime-switching)
   â”œâ”€ calibrate_tqqq.py (no regime switching)
   â””â”€ validate_eulb.py (uses fixed MA only)

## NEXT STEPS

1. âœ… Code fixed
2. âœ… Verification passed
3. â¬œ Run: python run_part12_only.py
4. â¬œ Compare new vs old results
5. â¬œ Continue with other bug fixes:
   â”œâ”€ Walk-forward testing (overfitting)
   â”œâ”€ RF consistency (Part 7-11 vs 12)
   â””â”€ Shiller dividend validation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Status: âœ… COMPLETE | Date: 2026-02-27 | Test: PASSED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
